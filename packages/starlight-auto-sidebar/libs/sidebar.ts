import type { StarlightRouteData } from '@astrojs/starlight/route-data'
import type { StarlightConfig } from '@astrojs/starlight/types'

// TODO(HiDeoo) some caching? what would be the things that could change between pages to invalidate the cache?

export function updateSidebar(config: SidebarItemConfig[], items: SidebarItem[]): SidebarItem[] {
  const sidebar: SidebarItem[] = []

  for (const [index, itemConfig] of config.entries()) {
    const item = items[index]
    if (!item) {
      continue
    } else if (isSidebarSlugItemConfig(itemConfig) || isSidebarLinkItemConfig(itemConfig)) {
      sidebar.push(item)
    } else if (isSidebarManualGroupConfig(itemConfig) && isSidebarGroup(item)) {
      sidebar.push({
        ...item,
        entries: updateSidebar(itemConfig.items, item.entries),
      })
    } else if (isSidebarAutogeneratedGroupConfig(itemConfig) && isSidebarGroup(item)) {
      sidebar.push({
        ...item,
        entries: updateAutogeneratedGroup(itemConfig, item.entries),
      })
    }
  }

  return sidebar
}

function updateAutogeneratedGroup(config: SidebarAutogeneratedGroupConfig, items: SidebarItem[]): SidebarItem[] {
  return items.map((item) => {
    if (item.type === 'group') {
      return {
        ...item,
        // TODO(HiDeoo)
        label: `${item.label} (modified)`,
        entries: updateAutogeneratedGroup(config, item.entries),
      }
    }

    return {
      ...item,
      // TODO(HiDeoo)
      label: `${item.label} (modified)`,
    }
  })
}

function isSidebarSlugItemConfig(itemConfig: SidebarItemConfig): itemConfig is SidebarSlugItemConfig {
  return 'slug' in itemConfig
}

function isSidebarLinkItemConfig(itemConfig: SidebarItemConfig): itemConfig is SidebarLinkItemConfig {
  return 'link' in itemConfig
}

function isSidebarManualGroupConfig(itemConfig: SidebarItemConfig): itemConfig is SidebarManualGroupConfig {
  return 'items' in itemConfig
}

function isSidebarAutogeneratedGroupConfig(
  itemConfig: SidebarItemConfig,
): itemConfig is SidebarAutogeneratedGroupConfig {
  return 'autogenerate' in itemConfig
}

function isSidebarGroup(item: SidebarItem): item is SidebarGroup {
  return item.type === 'group'
}

type SidebarItemConfig = NonNullable<StarlightConfig['sidebar']>[number]
type SidebarSlugItemConfig = Extract<SidebarItemConfig, { slug: string }>
type SidebarLinkItemConfig = Extract<SidebarItemConfig, { link: string }>
type SidebarManualGroupConfig = Extract<SidebarItemConfig, { items: SidebarItemConfig[] }>
type SidebarAutogeneratedGroupConfig = Extract<SidebarItemConfig, { autogenerate: { directory: string } }>

type SidebarItem = StarlightRouteData['sidebar'][number]
type SidebarGroup = Extract<SidebarItem, { type: 'group' }>
