import type { StarlightRouteData } from '@astrojs/starlight/route-data'
import type { StarlightUserConfig } from '@astrojs/starlight/types'
import context from 'virtual:starlight-auto-sidebar/context'

import { getDefinitionsForDirectory } from './definitions'

// TODO(HiDeoo) some caching? what would be the things that could change between pages to invalidate the cache?

export async function updateSidebar(config: SidebarItemConfig[], items: SidebarItem[]): Promise<SidebarItem[]> {
  const sidebar: SidebarItem[] = []

  for (const [index, itemConfig] of config.entries()) {
    const item = items[index]
    if (!item) {
      continue
    } else if (isSidebarSlugItemConfig(itemConfig) || isSidebarLinkItemConfig(itemConfig)) {
      sidebar.push(item)
    } else if (isSidebarManualGroupConfig(itemConfig) && isSidebarGroup(item)) {
      sidebar.push({
        ...item,
        entries: await updateSidebar(itemConfig.items, item.entries),
      })
    } else if (isSidebarAutogeneratedGroupConfig(itemConfig) && isSidebarGroup(item)) {
      sidebar.push({
        ...item,
        entries: await updateAutogeneratedGroup(itemConfig, item.entries),
      })
    }
  }

  return sidebar
}

async function updateAutogeneratedGroup(
  config: SidebarAutogeneratedGroupConfig,
  items: SidebarItem[],
  trail: string[] = [],
): Promise<SidebarItem[]> {
  const definitions = await getDefinitionsForDirectory(new URL(config.autogenerate.directory, context.contentDir))

  return Promise.all(
    items.map(async (item) => {
      const itemTrail = [...trail, item.label]
      const definition = definitions[itemTrail.join('/')]

      if (item.type === 'group') {
        const label = definition?.label ?? item.label

        return {
          ...item,
          label,
          entries: await updateAutogeneratedGroup(config, item.entries, itemTrail),
        }
      }

      return {
        ...item,
        // TODO(HiDeoo)
        label: `${item.label} (modified)`,
      }
    }),
  )
}

function isSidebarSlugItemConfig(itemConfig: SidebarItemConfig): itemConfig is SidebarSlugItemConfig {
  return typeof itemConfig === 'string' || 'slug' in itemConfig
}

function isSidebarLinkItemConfig(itemConfig: SidebarItemConfig): itemConfig is SidebarLinkItemConfig {
  return typeof itemConfig === 'object' && 'link' in itemConfig
}

function isSidebarManualGroupConfig(itemConfig: SidebarItemConfig): itemConfig is SidebarManualGroupConfig {
  return typeof itemConfig === 'object' && 'items' in itemConfig
}

function isSidebarAutogeneratedGroupConfig(
  itemConfig: SidebarItemConfig,
): itemConfig is SidebarAutogeneratedGroupConfig {
  return typeof itemConfig === 'object' && 'autogenerate' in itemConfig
}

function isSidebarGroup(item: SidebarItem): item is SidebarGroup {
  return item.type === 'group'
}

type SidebarItemConfig = NonNullable<StarlightUserConfig['sidebar']>[number]
type SidebarSlugItemConfig = Extract<SidebarItemConfig, string | { slug: string }>
type SidebarLinkItemConfig = Extract<SidebarItemConfig, { link: string }>
type SidebarManualGroupConfig = Extract<SidebarItemConfig, { items: SidebarItemConfig[] }>
type SidebarAutogeneratedGroupConfig = Extract<SidebarItemConfig, { autogenerate: { directory: string } }>

type SidebarItem = StarlightRouteData['sidebar'][number]
type SidebarGroup = Extract<SidebarItem, { type: 'group' }>
